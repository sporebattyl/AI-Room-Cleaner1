(()=>{var Z=Object.defineProperty;var u=(e,t)=>()=>(e&&(t=e(e=0)),t);var q=(e,t)=>{for(var o in t)Z(e,o,{get:t[o],enumerable:!0})};var r,A,d,K,H,W,O,B,E,i,f,ee,_,L,b,D,v=u(()=>{r={},A=()=>{r={messesList:document.getElementById("messes-list"),tasksCount:document.getElementById("tasks-count"),cleanlinessScore:document.getElementById("cleanliness-score"),loadingOverlay:document.getElementById("loading-overlay"),errorToast:document.getElementById("error-toast"),historyList:document.getElementById("history-list"),historyEmptyState:document.getElementById("history-empty-state"),resultsContainer:document.getElementById("results-container"),emptyState:document.getElementById("empty-state")}},d=e=>{for(;e.firstChild;)e.removeChild(e.firstChild)},K=e=>{let t=document.createElement("li");return t.textContent=e.mess,t.title=`Reason: ${e.reason||"N/A"}. Click to mark as complete.`,t.setAttribute("role","listitem"),t},H=e=>{if(e.length===0){W();return}let t=document.createDocumentFragment();e.forEach(o=>{t.appendChild(K(o))}),d(r.messesList),r.messesList.appendChild(t),r.tasksCount.textContent=e.length,r.emptyState.classList.add("hidden"),r.resultsContainer.classList.remove("hidden"),r.messesList.classList.remove("hidden")},W=()=>{d(r.messesList),r.tasksCount.textContent=0,r.messesList.classList.add("hidden"),r.emptyState.classList.remove("hidden"),r.resultsContainer.classList.add("hidden")},O=e=>{let t=r.cleanlinessScore;t.textContent=`${e}%`,t.classList.remove("score-high","score-medium","score-low"),e>=80?t.classList.add("score-high"):e>=50?t.classList.add("score-medium"):t.classList.add("score-low")},B=()=>{r.loadingOverlay.classList.remove("hidden")},E=()=>{r.loadingOverlay.classList.add("hidden")},i=(e,t=null)=>{let o="An unexpected error occurred.";navigator.onLine?typeof e=="string"?o=e:e instanceof Error&&(o=e.message,e.response&&e.response.data&&e.response.data.detail&&(o=e.response.data.detail)):o="You are offline. Please check your internet connection.";let s=document.createDocumentFragment(),a=document.createElement("span");if(a.textContent=o,s.appendChild(a),t){let l=document.createElement("button");l.textContent="Retry",l.onclick=()=>{f(),t()},s.appendChild(l)}d(r.errorToast),r.errorToast.appendChild(s),r.errorToast.classList.remove("hidden"),t||setTimeout(()=>{r.errorToast.classList.add("hidden")},5e3)},f=()=>{r.errorToast.classList.add("hidden")},ee=e=>{let t=document.createElement("li");t.setAttribute("role","listitem");let o=document.createElement("span");o.textContent=e.date;let s=document.createElement("span");return s.textContent=`${e.cleanliness_score}%`,t.appendChild(o),t.appendChild(s),t},_=()=>{d(r.historyList);let e=document.createElement("li");e.textContent="Loading history...",r.historyList.appendChild(e),r.historyEmptyState.classList.add("hidden"),r.historyList.classList.remove("hidden")},L=()=>{d(r.historyList)},b=e=>{L();let t=document.createDocumentFragment();e.length===0?(r.historyEmptyState.classList.remove("hidden"),r.historyList.classList.add("hidden")):(e.forEach(o=>{t.appendChild(ee(o))}),d(r.historyList),r.historyList.appendChild(t),r.historyEmptyState.classList.add("hidden"),r.historyList.classList.remove("hidden"))},D=()=>{r.resultsContainer.classList.remove("hidden")}});function te(e){let t;try{t=window[e];let o="__storage_test__";return t.setItem(o,o),t.removeItem(o),!0}catch(o){return o instanceof DOMException&&(o.code===22||o.code===1014||o.name==="QuotaExceededError"||o.name==="NS_ERROR_DOM_QUOTA_REACHED")&&t&&t.length!==0}}function N(){return[...y.history]}function k(){return y.currentTheme}function M(e){Array.isArray(e)?y.history=[...e]:console.error("Validation Error: setHistory expects an array.")}function p(e){typeof e=="string"?y.currentTheme=e:console.error("Validation Error: setCurrentTheme expects a string.")}var m,y,n,w=u(()=>{if(te("localStorage"))m={get:(e,t=null)=>{try{let o=localStorage.getItem(e);return o?JSON.parse(o):t}catch(o){return console.warn(`Could not read '${e}' from localStorage:`,o),t}},set:(e,t)=>{try{return localStorage.setItem(e,JSON.stringify(t)),!0}catch(o){return console.warn(`Could not write '${e}' to localStorage:`,o),!1}},remove:e=>{try{return localStorage.removeItem(e),!0}catch(t){return console.warn(`Could not remove '${e}' from localStorage:`,t),!1}}};else{console.warn("localStorage is not available. Falling back to in-memory storage.");let e={};m={get:(t,o=null)=>e.hasOwnProperty(t)?e[t]:o,set:(t,o)=>{try{return e[t]=JSON.parse(JSON.stringify(o)),!0}catch(s){return console.warn(`Could not store '${t}' in memory:`,s),!1}},remove:t=>(e.hasOwnProperty(t)&&delete e[t],!0)}}y={history:[],currentTheme:"light"};n={}});var z,oe,re,h,c,P,F,$,U=u(()=>{z=Object.freeze({ANALYZE_ROOM:"v1/analyze-room-secure",HISTORY:"history"}),oe=()=>`${window.location.origin}/api/`,re=e=>{let t=oe();return new URL(e,t).href},h=class extends Error{constructor(t){super(t),this.name="NetworkError"}},c=class extends Error{constructor(t,o){super(t),this.name="ServerError",this.status=o}},P=async(e,t={})=>{let o=re(e),s={...t.headers};t.body instanceof FormData||(s["Content-Type"]="application/json");try{let a=await fetch(o,{...t,headers:s});if(!a.ok){let l=`HTTP error! status: ${a.status}`;try{l=(await a.json()).detail||l}catch{}throw new c(l,a.status)}return a.json()}catch(a){throw a instanceof c?a:(console.error(`API call to ${o} failed:`,a),new h("Failed to connect to the server. Please check your network connection."))}},F=async e=>{let t=new FormData;t.append("file",e);try{return await P(z.ANALYZE_ROOM,{method:"POST",body:t})}catch(o){throw console.error("Error analyzing room:",o),o}},$=async()=>{try{return await P(z.HISTORY)}catch(e){throw console.error("Error fetching history:",e),e}}});var x,g,S,T,C,se,I,Y,j=u(()=>{U();v();w();x=async()=>{_();try{let e=await $();M(e),b(N())}catch(e){L(),e instanceof c?i(`Server error: ${e.message}`):e instanceof h?i(`Network error: ${e.message}`):i("An unexpected error occurred while loading history.")}},g=async()=>{let{fileInput:e,messesList:t}=n,o=e.files[0];if(!o){i("Please select an image to analyze.");return}B(),f();try{let s=await F(o);console.log("Analysis result:",s),H(s.tasks,t),O(s.cleanliness_score||0),D(),await x(),E()}catch(s){console.error("Analysis error:",s),E(),s instanceof c?i(`Server error: ${s.message}`,g):s instanceof h?i(`Network error: ${s.message}`,g):i("An unexpected error occurred during analysis.",g)}},S=()=>{console.warn("Clear history is disabled.")},T=()=>{let e=k()==="dark"?"light":"dark";p(e),document.documentElement.setAttribute("data-theme",e),m.set("theme",e)},C=e=>{e.target.tagName==="LI"&&e.target.classList.toggle("completed")},se=(e,t)=>{let o;return function(...s){clearTimeout(o),o=setTimeout(()=>{e.apply(this,s)},t)}},I=se(g,500),Y=()=>{n.analyzeBtn.addEventListener("click",I),n.themeToggleBtn.addEventListener("click",T),n.clearHistoryBtn.addEventListener("click",S),n.messesList.addEventListener("click",C)}});var G={};q(G,{cleanup:()=>R});var J,ne,V,R,Q=u(()=>{v();w();j();J=e=>{console.error("Unhandled promise rejection:",e.reason)};window.addEventListener("unhandledrejection",J);ne=async()=>{A(),n.analyzeBtn=document.getElementById("analyze-btn"),n.themeToggleBtn=document.getElementById("theme-toggle-btn"),n.clearHistoryBtn=document.getElementById("clear-history-btn"),n.messesList=document.getElementById("messes-list"),n.clearHistoryBtn.disabled=!0,n.clearHistoryBtn.title="This feature is not available yet.";let e=m.get("theme","light");p(e),document.documentElement.setAttribute("data-theme",e),await x()},V=async()=>{await ne(),Y()};document.addEventListener("DOMContentLoaded",V);R=()=>{window.removeEventListener("unhandledrejection",J),document.removeEventListener("DOMContentLoaded",V),window.removeEventListener("beforeunload",R),n.analyzeBtn&&n.analyzeBtn.removeEventListener("click",I),n.themeToggleBtn&&n.themeToggleBtn.removeEventListener("click",T),n.clearHistoryBtn&&n.clearHistoryBtn.removeEventListener("click",S),n.messesList&&n.messesList.removeEventListener("click",C)};window.addEventListener("beforeunload",R)});(async()=>{try{await Promise.resolve().then(()=>(Q(),G))}catch(e){console.error("Failed to load application modules:",e),document.body.innerHTML=`
            <div style="text-align: center; padding: 2rem; font-family: sans-serif;">
                <h1>Application Error</h1>
                <p>Could not load required components. Please check the console for details.</p>
                <p><i>This might happen if you are running the application from the local filesystem (file://). Please use a local web server.</i></p>
            </div>
        `}})();})();
